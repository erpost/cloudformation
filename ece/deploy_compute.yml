AWSTemplateFormatVersion: 2010-09-09
Description: Deploy ECE Compute

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      -
        Label:
          default: "CrossStack Reference"
        Parameters:
          - NetworkStackName
      -
        Label:
          default: "EC2 Configuration"
        Parameters:
          - AMIID
          - KeyName
          - KMSKey
          - ManagementInstanceType
          - MasterInstanceType
          - HotDataInstanceType
          - WarmDataInstanceType
          - PythonInstanceType
          - LogstashInstanceType
          - RabbitMQInstanceType
          - SSHLocation

Parameters:
  NetworkStackName:
    Description: Name of an active CloudFormation Stack that contains the Networking Resources
    Type: String
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '^[a-zA-Z][-a-zA-Z0-9]*$'
  AMIID:
    Description: ID of AMI
    Type: String
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: 'AWS::EC2::KeyPair::KeyName'
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  KMSKey:
    Description: AliasName of an existing KMS Key for encrypting Volumes
    Type: String
  ManagementInstanceType:
    Description: Management Server type
    Type: String
    Default: m5.2xlarge
    AllowedValues:
      - t2.nano
      - m5.2xlarge
    ConstraintDescription: Must be a valid EC2 instance type
  MasterInstanceType:
    Description: Master Server type
    Type: String
    Default: t3.2xlarge
    AllowedValues:
      - t2.nano
      - t3.2xlarge
    ConstraintDescription: Must be a valid EC2 instance type
  HotDataInstanceType:
    Description: Hot Data Server type
    Type: String
    Default: r5.2xlarge
    AllowedValues:
      - t2.nano
      - r5.2xlarge
    ConstraintDescription: Must be a valid EC2 instance type
  WarmDataInstanceType:
    Description: Warm Data Server type
    Type: String
    Default: h1.2xlarge
    AllowedValues:
      - t2.nano
      - h1.2xlarge
  PythonInstanceType:
    Description: Python Server type
    Type: String
    Default: t3.2xlarge
    AllowedValues:
      - t2.nano
      - t3.2xlarge
    ConstraintDescription: Must be a valid EC2 instance type
  LogstashInstanceType:
    Description: Logstash Server type
    Type: String
    Default: c5.4xlarge
    AllowedValues:
      - t2.nano
      - c5.4xlarge
    ConstraintDescription: Must be a valid EC2 instance type
  RabbitMQInstanceType:
    Description: RabbitMQ Server type
    Type: String
    Default: t3.2xlarge
    AllowedValues:
      - t2.nano
      - t3.2xlarge
    ConstraintDescription: Must be a valid EC2 instance type
  SSHLocation:
    Description: The IP address range that can be used to SSH to the Bastion Server
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: '(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})'
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x

Resources:
  SecurityGroupSSHInbound:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable SSH access via port 22
      GroupName: SSH External
      VpcId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-VPC"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: !Ref SSHLocation
  SecurityGroupHTTPSInbound:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable HTTPS access via port 443
      GroupName: HTTPS External
      VpcId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-VPC"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '443'
          ToPort: '443'
          CidrIp: !Ref SSHLocation
  SecurityGroupSSH:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable SSH access via port 22
      GroupName: SSH Internal
      VpcId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-VPC"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp:
            Fn::ImportValue:
              !Sub "${NetworkStackName}-VPCCIDR"
  SecurityGroupElastic:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Enable Elastic Internal Traffic
      GroupName: Elastic Internal
      VpcId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-VPC"
  SecurityGroupIngress1:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SecurityGroupElastic
      IpProtocol: tcp
      FromPort: '12443'
      ToPort: '12443'
      SourceSecurityGroupId: !Ref SecurityGroupElastic
  SecurityGroupIngress2:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SecurityGroupElastic
      IpProtocol: tcp
      FromPort: '9243'
      ToPort: '9243'
      SourceSecurityGroupId: !Ref SecurityGroupElastic

  MGMT1AZ1:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref ManagementInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet1"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["mgmt1-az1-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 1
  Master1AZ1:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref MasterInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet1"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["master1-az1-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 4
  HotData1AZ1:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref HotDataInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet1"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["hotdata1-az1-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 7
  WarmData1AZ1:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref WarmDataInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet1"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["warmdata1-az1-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 10
  MGMT1AZ2:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref ManagementInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet2"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["mgmt1-az2-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 2
  Master1AZ2:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref MasterInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet2"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["master1-az2-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 5
  HotData1AZ2:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref HotDataInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet2"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["hotdata1-az2-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 8
  WarmData1AZ2:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref WarmDataInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet2"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["warmdata1-az2-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 11
  MGMT1AZ3:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref ManagementInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet3"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["mgmt1-az3-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 3
  Master1AZ3:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref MasterInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet3"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["master1-az3-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 6
  HotData1AZ3:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref HotDataInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet3"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["hotdata1-az3-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 9
  WarmData1AZ3:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref WarmDataInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet3"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupElastic
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["warmdata1-az3-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 9
  Python1AZ1:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref PythonInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet4"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
        - !Ref SecurityGroupHTTPSInbound
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["python1-az1-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 13
  Logstash1AZ1:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref LogstashInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet4"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["logstash1-az1-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 14
  RabbitMQ1AZ1:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: !Ref RabbitMQInstanceType
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet4"
      SecurityGroupIds:
        - !Ref SecurityGroupSSH
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["rabbitmq1-az1-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: 17
  BastionHost:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: t2.micro
      SubnetId:
        Fn::ImportValue:
          !Sub "${NetworkStackName}-Subnet5"
      SecurityGroupIds:
        - !Ref SecurityGroupSSHInbound
      KeyName: !Ref KeyName
      ImageId: !Ref AMIID
      Tags:
        - Key: Name
          Value: !Join ['', ["bastion-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
        - Key: Host
          Value: Bastion
  BastionElasticIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      InstanceId: !Ref BastionHost
      Tags:
        - Key: Environment
          Value: elastic-poc
  VolumeMGMT1AZ1:
    Type: AWS::EC2::Volume
    Properties:
      Size: 100
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt MGMT1AZ1.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["mgmt1-az1-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeMGMT1AZ1:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref MGMT1AZ1
      VolumeId: !Ref VolumeMGMT1AZ1
  VolumeMaster1AZ1:
    Type: AWS::EC2::Volume
    Properties:
      Size: 100
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt Master1AZ1.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["master1-az1-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeMaster1AZ1:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref Master1AZ1
      VolumeId: !Ref VolumeMaster1AZ1
  VolumeHotData1AZ1:
    Type: AWS::EC2::Volume
    Properties:
      Size: 1024
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt HotData1AZ1.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["hotdata1-az1-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeHotData1AZ1:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref HotData1AZ1
      VolumeId: !Ref VolumeHotData1AZ1
  VolumeWarmData1AZ1:
    Type: AWS::EC2::Volume
    Properties:
      Size: 2048
      VolumeType: st1
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt WarmData1AZ1.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["warmdata1-az1-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeWarmData1AZ1:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref WarmData1AZ1
      VolumeId: !Ref VolumeWarmData1AZ1
  VolumeMGMT1AZ2:
    Type: AWS::EC2::Volume
    Properties:
      Size: 100
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt MGMT1AZ2.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["mgmt1-az2-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeMGMT1AZ2:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref MGMT1AZ2
      VolumeId: !Ref VolumeMGMT1AZ2
  VolumeMaster1AZ2:
    Type: AWS::EC2::Volume
    Properties:
      Size: 100
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt Master1AZ2.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["master1-az2-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeMaster1AZ2:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref Master1AZ2
      VolumeId: !Ref VolumeMaster1AZ2
  VolumeHotData1AZ2:
    Type: AWS::EC2::Volume
    Properties:
      Size: 1024
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt HotData1AZ2.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["hotdata1-az2-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeHotData1AZ2:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref HotData1AZ2
      VolumeId: !Ref VolumeHotData1AZ2
  VolumeWarmData1AZ2:
    Type: AWS::EC2::Volume
    Properties:
      Size: 2048
      VolumeType: st1
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt WarmData1AZ2.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["warmdata1-az2-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeWarmData1AZ2:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref WarmData1AZ2
      VolumeId: !Ref VolumeWarmData1AZ2
  VolumeMGMT1AZ3:
    Type: AWS::EC2::Volume
    Properties:
      Size: 100
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt MGMT1AZ3.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["mgmt1-az3-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeMGMT1AZ3:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref MGMT1AZ3
      VolumeId: !Ref VolumeMGMT1AZ3
  VolumeMaster1AZ3:
    Type: AWS::EC2::Volume
    Properties:
      Size: 100
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt Master1AZ3.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["master1-az3-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeMaster1AZ3:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref Master1AZ3
      VolumeId: !Ref VolumeMaster1AZ3
  VolumeHotData1AZ3:
    Type: AWS::EC2::Volume
    Properties:
      Size: 1024
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt HotData1AZ3.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["hotdata1-az3-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeHotData1AZ3:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref HotData1AZ3
      VolumeId: !Ref VolumeHotData1AZ3
  VolumeWarmData1AZ3:
    Type: AWS::EC2::Volume
    Properties:
      Size: 2048
      VolumeType: st1
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt WarmData1AZ3.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["warmdata1-az3-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeWarmData1AZ3:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref WarmData1AZ3
      VolumeId: !Ref VolumeWarmData1AZ3
  VolumePython1AZ1:
    Type: AWS::EC2::Volume
    Properties:
      Size: 100
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt Python1AZ1.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["python1-az1-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumePython1AZ1:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref Python1AZ1
      VolumeId: !Ref VolumePython1AZ1
  VolumeLogstash1AZ1:
    Type: AWS::EC2::Volume
    Properties:
      Size: 500
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt Logstash1AZ1.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["logstash1-az1-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeLogstash1AZ1:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref Logstash1AZ1
      VolumeId: !Ref VolumeLogstash1AZ1
  VolumeRabbitMQ1AZ1:
    Type: AWS::EC2::Volume
    Properties:
      Size: 200
      VolumeType: gp2
      Encrypted: true
      KmsKeyId: !Join ['', ["alias/", !Ref "KMSKey" ]]
      AvailabilityZone: !GetAtt RabbitMQ1AZ1.AvailabilityZone
      Tags:
        - Key: Name
          Value: !Join ['', ["rabbitmq1-az1-vol-", !Ref "AWS::StackName" ]]
        - Key: Environment
          Value: elastic-poc
  AttachVolumeRabbitMQ1AZ1:
    Type: AWS::EC2::VolumeAttachment
    Properties:
      Device: /dev/sdb
      InstanceId: !Ref RabbitMQ1AZ1
      VolumeId: !Ref VolumeRabbitMQ1AZ1

Outputs:
  MGMT1AZ1PrivateIP:
    Description: Private IP of MGMT1AZ1 (Host 01)
    Value: !GetAtt MGMT1AZ1.PrivateIp
  MGMT1AZ2PrivateIP:
    Description: Private IP of MGMT1AZ2 (Host 02)
    Value: !GetAtt MGMT1AZ2.PrivateIp
  MGMT1AZ3PrivateIP:
    Description: Private IP of MGMT1AZ3 (Host 03)
    Value: !GetAtt MGMT1AZ3.PrivateIp
  Master1AZ1PrivateIP:
    Description: Private IP of Master1AZ1 (Host 04)
    Value: !GetAtt Master1AZ1.PrivateIp
  Master1AZ2PrivateIP:
    Description: Private IP of Master1AZ2 (Host 05)
    Value: !GetAtt Master1AZ2.PrivateIp
  Master1AZ3PrivateIP:
    Description: Private IP of Master1AZ3 (Host 06)
    Value: !GetAtt Master1AZ3.PrivateIp
  HotData1AZ1PrivateIP:
    Description: Private IP of HotData1AZ1 (Host 07)
    Value: !GetAtt HotData1AZ1.PrivateIp
  HotData1AZ2PrivateIP:
    Description: Private IP of HotData1AZ2 (Host 08)
    Value: !GetAtt HotData1AZ2.PrivateIp
  HotData1AZ3PrivateIP:
    Description: Private IP of HotData1AZ3 (Host 09)
    Value: !GetAtt HotData1AZ3.PrivateIp
  WarmData1AZ1PrivateIP:
    Description: Private IP of WarmData1AZ1 (Host 10)
    Value: !GetAtt WarmData1AZ1.PrivateIp
  WarmData1AZ2PrivateIP:
    Description: Private IP of WarmData1AZ2 (Host 11)
    Value: !GetAtt WarmData1AZ2.PrivateIp
  WarmData1AZ3PrivateIP:
    Description: Private IP of WarmData1AZ3 (Host 12)
    Value: !GetAtt WarmData1AZ3.PrivateIp
  BastionHostPublicIP:
    Description: Public IP of Bastion Host
    Value: !GetAtt BastionHost.PublicIp
